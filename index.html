<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Premium Business Intelligence Dashboard</title>

  <!-- Tailwind & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- date-fns UMD (exposes window.dateFns) -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/dist/date-fns.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #E2E8F0; }
    .header-font { font-family: 'Poppins', sans-serif; }
    .data-font { font-family: 'Roboto Mono', monospace; }
    .chart-container { position: relative; width: 100%; height: 320px; max-height: 400px; }
    .kpi-card { transition: transform .2s, box-shadow .2s; border-radius: .75rem; background-color: #1E293B; box-shadow: 0 4px 6px rgba(0,0,0,.2), 0 10px 15px rgba(0,0,0,.2); }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,.3), 0 20px 25px rgba(0,0,0,.3); }
    .control-btn.active, .tab-btn.active { background-color: #3B82F6; color: #fff; }
    .control-btn, .tab-btn { transition: background-color .2s, color .2s; font-weight: 500; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card-bg { background-color: #1E293B; }
    .panel-bg { background-color: #334155; }
  </style>
</head>
<body class="p-4 sm:p-6 lg:p-12">
  <div class="max-w-7xl mx-auto">
    <header class="mb-8">
      <h1 class="text-4xl font-bold header-font text-[#F1F5F9]">Business Intelligence Dashboard</h1>
      <p class="text-gray-400 mt-2 text-lg">A premium overview of key metrics.</p>
    </header>

    <section id="data-upload" class="mb-8 p-6 card-bg rounded-xl shadow-lg">
      <h2 class="text-2xl font-semibold header-font text-white mb-2">Data Operations</h2>
      <p class="text-gray-400 text-sm mb-4">Upload a CSV file to refresh the dashboard or manage user data.</p>
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <input type="file" id="data-file-input" accept=".csv" class="w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700"/>
        <button id="load-data-btn" class="w-full sm:w-auto px-6 py-2 text-sm font-semibold rounded-full text-white bg-gray-500 hover:bg-gray-600 transition-colors">Load Data</button>
      </div>
      <div id="upload-status" class="mt-4 text-sm font-medium text-red-400"></div>
    </section>

    <section id="tabs" class="mb-8">
      <div class="flex items-center gap-2 bg-slate-800 p-1 rounded-full shadow-lg">
        <button class="tab-btn active px-6 py-2 text-sm rounded-full" data-target="overview-tab" id="tab-overview">Overview</button>
        <button class="tab-btn px-6 py-2 text-sm rounded-full" data-target="order-analysis-tab" id="tab-order-analysis">Order Analysis</button>
        <button class="tab-btn px-6 py-2 text-sm rounded-full" data-target="insights-tab" id="tab-insights">Insights & Predictions</button>
      </div>
    </section>

    <!-- Tab Content -->
    <div id="overview-tab" class="tab-content active">
      <section id="controls" class="mb-8 p-6 card-bg rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-2 bg-slate-800 p-1 rounded-full">
          <button id="mom-btn" class="control-btn active px-6 py-2 text-sm rounded-full">MoM</button>
          <button id="wow-btn" class="control-btn px-6 py-2 text-sm rounded-full">WoW</button>
          <button id="dod-btn" class="control-btn px-6 py-2 text-sm rounded-full">DoD</button>
        </div>
        <div class="flex items-center gap-2">
          <label for="period-select" class="text-sm font-medium text-gray-400">Select Period:</label>
          <select id="period-select" class="bg-slate-800 border-gray-600 text-gray-300 text-sm rounded-full focus:ring-2 focus:ring-blue-600 focus:border-blue-600 block w-full p-2.5"></select>
        </div>
      </section>

      <section id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
        <div class="kpi-card p-8">
          <h3 class="text-gray-400 text-sm font-medium">Total Revenue</h3>
          <p id="kpi-revenue" class="text-4xl font-semibold mt-2 data-font text-white">₹0</p>
          <p id="kpi-revenue-change" class="text-sm mt-1 font-semibold text-green-400">+0% vs last period</p>
        </div>
        <div class="kpi-card p-8">
          <h3 class="text-gray-400 text-sm font-medium">New Customers</h3>
          <p id="kpi-customers" class="text-4xl font-semibold mt-2 data-font text-white">0</p>
          <p id="kpi-customers-change" class="text-sm mt-1 font-semibold text-green-400">+0% vs last period</p>
        </div>
        <div class="kpi-card p-8">
          <h3 class="text-gray-400 text-sm font-medium">Total Orders</h3>
          <p id="kpi-orders" class="text-4xl font-semibold mt-2 data-font text-white">0</p>
          <p id="kpi-orders-change" class="text-sm mt-1 font-semibold text-green-400">+0% vs last period</p>
        </div>
        <div class="kpi-card p-8">
          <h3 class="text-gray-400 text-sm font-medium">Avg. Order Value</h3>
          <p id="kpi-aov" class="text-4xl font-semibold mt-2 data-font text-white">₹0.00</p>
          <p id="kpi-aov-change" class="text-sm mt-1 font-semibold text-red-400">-0% vs last period</p>
        </div>
      </section>

      <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="card-bg p-8 rounded-xl shadow-lg">
          <h2 class="text-2xl font-semibold header-font text-white mb-1">User Retention</h2>
          <p class="text-sm text-gray-400 mb-4">Tracks the percentage of new customers who make a repeat purchase in subsequent periods.</p>
          <div class="chart-container"><canvas id="retentionChart"></canvas></div>
        </div>
        <div class="card-bg p-8 rounded-xl shadow-lg">
          <h2 class="text-2xl font-semibold header-font text-white mb-1">Avg. Revenue Per User (ARPU)</h2>
          <p class="text-sm text-gray-400 mb-4">The average revenue generated from each active customer over time.</p>
          <div class="chart-container"><canvas id="arpuChart"></canvas></div>
        </div>
      </main>
    </div>

    <!-- Order Analysis Tab Content -->
    <div id="order-analysis-tab" class="tab-content">
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
        <div class="card-bg p-8 rounded-xl shadow-lg">
          <h2 class="text-2xl font-semibold header-font text-white mb-1">User Recency & Aging Trends</h2>
          <p class="text-sm text-gray-400 mb-4">A comparative view of ARPU, AOV, and Total Orders across user segments based on purchase recency and account age.</p>
          <div class="chart-container"><canvas id="recencyAgingChart"></canvas></div>
        </div>
        <div class="card-bg p-8 rounded-xl shadow-lg">
          <h2 class="text-2xl font-semibold header-font text-white mb-1">Order Rank Funnel</h2>
          <p class="text-sm text-gray-400 mb-4">Visualizes the funnel movement and displays key metrics for each order rank.</p>
          <div class="chart-container"><canvas id="orderRankFunnelChart"></canvas></div>
        </div>
        <div class="card-bg p-8 rounded-xl shadow-lg">
          <h2 class="text-2xl font-semibold header-font text-white mb-1">Repeat Order Conversion</h2>
          <p class="text-sm text-gray-400 mb-4">Tracks the percentage of customers who move from a first order to subsequent ones.</p>
          <div class="chart-container"><canvas id="conversionChart"></canvas></div>
        </div>
        <div class="card-bg p-8 rounded-xl shadow-lg">
          <h2 class="text-2xl font-semibold header-font text-white mb-1">Average Order Value (AOV)</h2>
          <p class="text-sm text-gray-400 mb-4">Compares the average transaction value in the current vs. previous period.</p>
          <div class="chart-container"><canvas id="aovChart"></canvas></div>
        </div>
      </section>
    </div>

    <!-- Insights Tab Content -->
    <div id="insights-tab" class="tab-content">
      <section class="mt-8 p-8 card-bg rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold header-font text-white mb-4">Performance Insights</h2>
        <div id="insights-content" class="text-gray-300 leading-relaxed space-y-6"></div>
      </section>

      <section class="mt-8 p-8 card-bg rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold header-font text-white mb-4">Month Closure Projections</h2>
        <div id="prediction-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="panel-bg p-6 rounded-lg shadow-md">
            <h3 class="font-medium text-gray-400">Predicted Revenue</h3>
            <p id="pred-revenue" class="text-3xl font-semibold mt-1 data-font text-blue-400">₹0</p>
          </div>
          <div class="panel-bg p-6 rounded-lg shadow-md">
            <h3 class="font-medium text-gray-400">Predicted Orders</h3>
            <p id="pred-orders" class="text-3xl font-semibold mt-1 data-font text-blue-400">0</p>
          </div>
          <div class="panel-bg p-6 rounded-lg shadow-md">
            <h3 class="font-medium text-gray-400">Predicted New Users</h3>
            <p id="pred-users" class="text-3xl font-semibold mt-1 data-font text-blue-400">0</p>
          </div>
          <div class="panel-bg p-6 rounded-lg shadow-md col-span-1 md:col-span-2 lg:col-span-1">
            <h3 class="font-medium text-gray-400">Predicted Funnel Movement</h3>
            <p id="pred-funnel" class="text-sm mt-1 data-font text-gray-300">1st to 2nd: 0%<br>2nd to 3rd: 0%</p>
          </div>
          <div class="panel-bg p-6 rounded-lg shadow-md">
            <h3 class="font-medium text-gray-400">Predicted WC per User</h3>
            <p id="pred-wc" class="text-3xl font-semibold mt-1 data-font text-blue-400">₹0.00</p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const {
        parseISO, format, startOfMonth, startOfWeek, addMonths, subMonths,
        addWeeks, subWeeks, addDays, subDays, getUnixTime, differenceInDays,
        isBefore, isAfter, startOfDay
      } = window.dateFns;

      let state = {
        view: 'mom', // 'mom' | 'wow' | 'dod'
        selectedPeriod: format(startOfMonth(new Date()), 'yyyy-MM-dd'),
      };

      let charts = {};
      let allOrders = [];

      // -------------------- Data helpers --------------------
      const generateMockData = () => {
        const data = [];
        const customerBase = {};
        const today = startOfDay(new Date());

        for (let i = 0; i < 30 * 15; i++) {
          const date = subDays(today, i);
          const dailyNewCustomers = Math.floor(Math.random() * 10) + 5;

          for (let j = 0; j < dailyNewCustomers; j++) {
            const id = `C${Object.keys(customerBase).length + 1}`;
            customerBase[id] = { acquisitionDate: date, orderCount: 0 };
          }

          const dailyOrders = Math.floor(Math.random() * 50) + 30;
          const customerKeys = Object.keys(customerBase);

          for (let k = 0; k < dailyOrders; k++) {
            const randomCustomerId = customerKeys[Math.floor(Math.random() * customerKeys.length)];
            const customer = customerBase[randomCustomerId];
            if (getUnixTime(date) < getUnixTime(customer.acquisitionDate)) continue;

            customer.orderCount++;
            const orderValue = +(Math.random() * 100 + 10).toFixed(2);
            data.push({
              customerId: randomCustomerId,
              orderDate: date,
              orderValue,
              acquisitionDate: customer.acquisitionDate,
              orderRank: customer.orderCount,
            });
          }
        }
        return data;
      };

      const parseCSV = (csvText) => {
        const lines = csvText.trim().split('\n').filter(Boolean);
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim());
          const row = {};
          headers.forEach((h, i) => row[h] = values[i]);
          return {
            customerId: row.customerId,
            orderDate: parseISO(row.orderDate),
            orderValue: parseFloat(row.orderValue),
            acquisitionDate: parseISO(row.acquisitionDate),
            orderRank: parseInt(row.orderRank, 10),
          };
        });
      };

      // -------------------- KPI & period logic --------------------
      const getChangePercentage = (current, previous) => {
        if (previous === 0) return current > 0 ? 100 : 0;
        const pct = ((current - previous) / previous) * 100;
        return Math.round(pct * 10) / 10; // number, one decimal
      };

      const formatINR = (v) => `₹${v.toLocaleString('en-IN', { maximumFractionDigits: 0 })}`;
      const formatINRDec = (v) => `₹${v.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

      const updateKpiCard = (id, value, change, formatter) => {
        document.getElementById(`kpi-${id}`).textContent = formatter(value);
        const el = document.getElementById(`kpi-${id}-change`);
        el.textContent = `${change >= 0 ? '+' : ''}${change}% vs last period`;
        el.classList.toggle('text-green-400', change >= 0);
        el.classList.toggle('text-red-400', change < 0);
      };

      const processDataForPeriod = (orders, period, view) => {
        const periodStart = parseISO(period);
        let periodEnd, prevPeriodStart;

        if (view === 'mom') { periodEnd = addMonths(periodStart, 1); prevPeriodStart = subMonths(periodStart, 1); }
        else if (view === 'wow') { periodEnd = addWeeks(periodStart, 1); prevPeriodStart = subWeeks(periodStart, 1); }
        else { periodEnd = addDays(periodStart, 1); prevPeriodStart = subDays(periodStart, 1); }

        const inRange = (d, a, b) => getUnixTime(d) >= getUnixTime(a) && getUnixTime(d) < getUnixTime(b);
        const currentPeriodOrders = orders.filter(o => inRange(o.orderDate, periodStart, periodEnd));
        const prevPeriodOrders = orders.filter(o => inRange(o.orderDate, prevPeriodStart, periodStart));
        return { currentPeriodOrders, prevPeriodOrders, periodStart, periodEnd, prevPeriodStart };
      };

      const calculateKPIs = (currentOrders, prevOrders) => {
        const revenue = currentOrders.reduce((s,o)=>s+o.orderValue,0);
        const prevRevenue = prevOrders.reduce((s,o)=>s+o.orderValue,0);

        const newCustomers = new Set(currentOrders.filter(o=>o.orderRank===1).map(o=>o.customerId)).size;
        const prevNewCustomers = new Set(prevOrders.filter(o=>o.orderRank===1).map(o=>o.customerId)).size;

        const totalOrders = currentOrders.length;
        const prevTotalOrders = prevOrders.length;

        const aov = totalOrders ? revenue/totalOrders : 0;
        const prevAov = prevTotalOrders ? prevRevenue/prevTotalOrders : 0;

        updateKpiCard('revenue', revenue, getChangePercentage(revenue, prevRevenue), formatINR);
        updateKpiCard('customers', newCustomers, getChangePercentage(newCustomers, prevNewCustomers), v => v.toLocaleString('en-IN'));
        updateKpiCard('orders', totalOrders, getChangePercentage(totalOrders, prevTotalOrders), v => v.toLocaleString('en-IN'));
        updateKpiCard('aov', aov, getChangePercentage(aov, prevAov), formatINRDec);
      };

      // -------------------- Missing analytics (now implemented) --------------------
      const bucketAdder = (view) => view === 'mom' ? addMonths : view === 'wow' ? addWeeks : addDays;

      // Retention: cohort = users with first order in the selected period.
      // For next 6 periods, % of cohort who ordered in that bucket.
      const calculateRetention = (orders, periodStart, view) => {
        const add = bucketAdder(view);
        const periodEnd = view === 'mom' ? addMonths(periodStart,1) : view === 'wow' ? addWeeks(periodStart,1) : addDays(periodStart,1);

        // cohort by first-ever order in period
        const firstOrderByUser = {};
        orders.forEach(o => {
          if (!firstOrderByUser[o.customerId] || isBefore(o.orderDate, firstOrderByUser[o.customerId])) {
            firstOrderByUser[o.customerId] = o.orderDate;
          }
        });
        const cohortUsers = Object.entries(firstOrderByUser)
          .filter(([_, d]) => getUnixTime(d) >= getUnixTime(periodStart) && getUnixTime(d) < getUnixTime(periodEnd))
          .map(([id]) => id);

        const labels = ['P+1','P+2','P+3','P+4','P+5','P+6'];
        const data = [];

        for (let i = 1; i <= 6; i++) {
          const start = add(periodStart, i);
          const end = add(periodStart, i+1);
          const active = new Set(
            orders
              .filter(o => cohortUsers.includes(o.customerId))
              .filter(o => getUnixTime(o.orderDate) >= getUnixTime(start) && getUnixTime(o.orderDate) < getUnixTime(end))
              .map(o => o.customerId)
          ).size;
          const pct = cohortUsers.length ? (active / cohortUsers.length) * 100 : 0;
          data.push(Math.round(pct * 10) / 10);
        }
        return { labels, data };
      };

      // ARPU over time inside current vs previous period (daily points)
      const calculateArpu = (orders, periodStart, view) => {
        const add = bucketAdder(view);
        const periodEnd = view === 'mom' ? addMonths(periodStart,1) : view === 'wow' ? addWeeks(periodStart,1) : addDays(periodStart,1);
        const prevStart = view === 'mom' ? subMonths(periodStart,1) : view === 'wow' ? subWeeks(periodStart,1) : subDays(periodStart,1);
        const prevEnd = periodStart;

        // build daily (or per-unit-day) ticks for chart readability
        const points = [];
        let cursor = periodStart;
        while (isBefore(cursor, periodEnd)) {
          points.push(cursor);
          cursor = addDays(cursor, 1); // visualize by days for all views
        }
        const labels = points.map((d,i)=>`Day ${i+1}`);

        const seriesFor = (start, end) => points.map((pt,i) => {
          const dayStart = pt;
          const dayEnd = addDays(pt, 1);
          const dayOrders = orders.filter(o => getUnixTime(o.orderDate) >= getUnixTime(dayStart) && getUnixTime(o.orderDate) < getUnixTime(dayEnd) && getUnixTime(o.orderDate) >= getUnixTime(start) && getUnixTime(o.orderDate) < getUnixTime(end));
          const revenue = dayOrders.reduce((s,o)=>s+o.orderValue,0);
          const users = new Set(dayOrders.map(o=>o.customerId)).size;
          return users ? revenue / users : 0;
        });

        return {
          labels,
          currentData: seriesFor(periodStart, periodEnd),
          prevData: seriesFor(prevStart, prevEnd)
        };
      };

      const calculateRecencyAging = (orders) => {
        const today = startOfDay(new Date());
        const customers = {};
        orders.forEach(o => {
          if (!customers[o.customerId]) customers[o.customerId] = { acquisitionDate: o.acquisitionDate, lastOrderDate: o.orderDate, orders: [o] };
          else { customers[o.customerId].orders.push(o); if (isAfter(o.orderDate, customers[o.customerId].lastOrderDate)) customers[o.customerId].lastOrderDate = o.orderDate; }
        });

        const segments = {
          recency: { '0-7 Days': [], '8-30 Days': [], '>30 Days': [] },
          aging: { '0-30 Days': [], '31-90 Days': [], '>90 Days': [] }
        };

        Object.values(customers).forEach(c => {
          const daysSinceLast = differenceInDays(today, c.lastOrderDate);
          if (daysSinceLast <= 7) segments.recency['0-7 Days'].push(...c.orders);
          else if (daysSinceLast <= 30) segments.recency['8-30 Days'].push(...c.orders);
          else segments.recency['>30 Days'].push(...c.orders);

          const daysSinceAcq = differenceInDays(today, c.acquisitionDate);
          if (daysSinceAcq <= 30) segments.aging['0-30 Days'].push(...c.orders);
          else if (daysSinceAcq <= 90) segments.aging['31-90 Days'].push(...c.orders);
          else segments.aging['>90 Days'].push(...c.orders);
        });

        const metrics = (arr) => {
          const revenue = arr.reduce((s,o)=>s+o.orderValue,0);
          const uniqueUsers = new Set(arr.map(o=>o.customerId)).size;
          return {
            arpu: uniqueUsers ? revenue/uniqueUsers : 0,
            aov: arr.length ? revenue/arr.length : 0,
            totalOrders: arr.length,
            uniqueUsers
          };
        };

        const recencyMetrics = Object.fromEntries(Object.entries(segments.recency).map(([k,v]) => [k, metrics(v)]));
        const agingMetrics = Object.fromEntries(Object.entries(segments.aging).map(([k,v]) => [k, metrics(v)]));
        return { recencyMetrics, agingMetrics };
      };

      const calculateOrderRankFunnel = (orders) => {
        const ranked = {};
        orders.forEach(o => {
          const key = o.orderRank >= 5 ? '5+' : String(o.orderRank);
          if (!ranked[key]) ranked[key] = { revenue: 0, orders: 0 };
          ranked[key].revenue += o.orderValue;
          ranked[key].orders += 1;
        });
        const labels = Object.keys(ranked).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true})).map(l => `Order Rank ${l}`);
        const totalRevenues = labels.map(l => {
          const k = l.replace('Order Rank ','');
          return ranked[k].revenue;
        });
        const aovs = labels.map(l => {
          const k = l.replace('Order Rank ','');
          return ranked[k].orders ? ranked[k].revenue / ranked[k].orders : 0;
        });
        return { labels, totalRevenues, aovs };
      };

      const calculateConversion = (currentOrders) => {
        const ranks = [1,2,3,4];
        const usersByRank = {};
        ranks.forEach(r => usersByRank[r] = new Set(currentOrders.filter(o => o.orderRank === r).map(o => o.customerId)));
        const labels = ['1→2','2→3','3→4','4→5+'];
        const data = ranks.map(r => {
          const base = usersByRank[r].size;
          const next = r === 4
            ? new Set(currentOrders.filter(o => o.orderRank >= 5).map(o => o.customerId)).size
            : usersByRank[r+1].size;
          return base ? Math.round((next / base) * 1000)/10 : 0;
        });
        return { labels, data };
      };

      const calculateAov = (currentOrders, prevOrders) => {
        const rev = currentOrders.reduce((s,o)=>s+o.orderValue,0);
        const revPrev = prevOrders.reduce((s,o)=>s+o.orderValue,0);
        const aov = currentOrders.length ? rev / currentOrders.length : 0;
        const aovPrev = prevOrders.length ? revPrev / prevOrders.length : 0;
        return { data: [aovPrev, aov] };
      };

      const generateInsights = (currentOrders, prevOrders) => {
        const insights = [];

        const revenue = currentOrders.reduce((s,o)=>s+o.orderValue,0);
        const prevRevenue = prevOrders.reduce((s,o)=>s+o.orderValue,0);
        const revenueChange = getChangePercentage(revenue, prevRevenue);

        insights.push(revenueChange >= 0
          ? `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>Revenue is trending positively with a <strong>+${revenueChange}%</strong> increase from the last period.</p>`
          : `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>Revenue has declined by <strong>${revenueChange}%</strong> vs last period.</p>`
        );

        const newCustomers = new Set(currentOrders.filter(o=>o.orderRank===1).map(o=>o.customerId)).size;
        const prevNewCustomers = new Set(prevOrders.filter(o=>o.orderRank===1).map(o=>o.customerId)).size;
        const customerChange = getChangePercentage(newCustomers, prevNewCustomers);
        insights.push(customerChange >= 0
          ? `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>New users grew <strong>+${customerChange}%</strong>.</p>`
          : `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>New user acquisition down <strong>${customerChange}%</strong>.</p>`
        );

        const aov = currentOrders.length ? revenue/currentOrders.length : 0;
        const prevAov = prevOrders.length ? prevRevenue/prevOrders.length : 0;
        const aovChange = getChangePercentage(aov, prevAov);
        insights.push(aovChange >= 0
          ? `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>AOV is up <strong>+${aovChange}%</strong>.</p>`
          : `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>AOV decreased <strong>${aovChange}%</strong>.</p>`
        );

        return insights;
      };

      const predictMonthEndValues = (orders) => {
        const today = new Date();
        const start = startOfMonth(today);
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        const daysPassed = differenceInDays(today, start) || 1;

        const currentMonthOrders = orders.filter(o => getUnixTime(o.orderDate) >= getUnixTime(start) && getUnixTime(o.orderDate) < getUnixTime(today));
        const totalRevenue = currentMonthOrders.reduce((s,o)=>s+o.orderValue,0);
        const totalOrders = currentMonthOrders.length;
        const newUsers = new Set(currentMonthOrders.filter(o=>o.orderRank===1).map(o=>o.customerId)).size;
        const secondOrderCustomers = new Set(currentMonthOrders.filter(o=>o.orderRank===2).map(o=>o.customerId)).size;

        const dailyRevenueRate = totalRevenue / daysPassed;
        const dailyOrdersRate = totalOrders / daysPassed;
        const dailyUsersRate = newUsers / daysPassed;
        const remainingDays = daysInMonth - daysPassed;

        const predictedRevenue = totalRevenue + dailyRevenueRate * remainingDays;
        const predictedOrders = totalOrders + dailyOrdersRate * remainingDays;
        const predictedUsers = newUsers + dailyUsersRate * remainingDays;
        const predictedFunnel = { '1st to 2nd': newUsers ? (secondOrderCustomers / newUsers) * 100 : 0 };
        const predictedWC = totalOrders ? totalRevenue / totalOrders : 0;

        return { revenue: predictedRevenue, orders: predictedOrders, users: predictedUsers, funnel: predictedFunnel, wc: predictedWC };
      };

      // -------------------- Chart plumbing --------------------
      const updateChart = (chartInstance, labels, datasets, options = {}) => {
        chartInstance.data.labels = labels;
        chartInstance.data.datasets = datasets;
        chartInstance.options.plugins.tooltip.callbacks = options.tooltipCallbacks || {};
        if (options.horizontal) chartInstance.options.indexAxis = 'y';
        else chartInstance.options.indexAxis = 'x';
        chartInstance.update();
      };

      const initCharts = () => {
        const defaultOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#94A3B8', boxWidth: 10 } },
            tooltip: { backgroundColor: '#334155', titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 12 }, padding: 12, cornerRadius: 8, borderColor: '#3B82F6', borderWidth: 1 }
          },
          scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94A3B8' } },
            x: { grid: { display: false }, ticks: { color: '#94A3B8' } }
          }
        };

        charts.retention = new Chart(document.getElementById('retentionChart'), { type: 'line', data: { labels: [], datasets: [] }, options: defaultOptions });
        charts.arpu = new Chart(document.getElementById('arpuChart'), { type: 'line', data: { labels: [], datasets: [] }, options: defaultOptions });
        charts.recencyAging = new Chart(document.getElementById('recencyAgingChart'), { type: 'bar', data: { labels: [], datasets: [] }, options: defaultOptions });
        charts.orderRankFunnel = new Chart(document.getElementById('orderRankFunnelChart'), { type: 'bar', data: { labels: [], datasets: [] }, options: defaultOptions });
        charts.conversion = new Chart(document.getElementById('conversionChart'), { type: 'bar', data: { labels: [], datasets: [] }, options: { ...defaultOptions, indexAxis: 'y' } });
        charts.aov = new Chart(document.getElementById('aovChart'), { type: 'bar', data: { labels: [], datasets: [] }, options: { ...defaultOptions, plugins: { ...defaultOptions.plugins, legend: { display: false } } } });
      };

      // -------------------- UI & rendering --------------------
      const populatePeriodSelector = () => {
        const select = document.getElementById('period-select');
        select.innerHTML = '';
        const periods = 12;
        const today = new Date();

        for (let i = 0; i < periods; i++) {
          let date, text;
          if (state.view === 'mom') {
            date = startOfMonth(subMonths(today, i));
            text = format(date, 'MMMM yyyy');
          } else if (state.view === 'wow') {
            date = startOfWeek(subWeeks(today, i), { weekStartsOn: 1 });
            text = `Week of ${format(date, 'MMM d, yyyy')}`;
          } else {
            date = subDays(today, i);
            text = format(date, 'MMM d, yyyy');
          }
          const option = document.createElement('option');
          option.value = format(date, 'yyyy-MM-dd');
          option.textContent = text;
          select.appendChild(option);
        }
        state.selectedPeriod = select.value;
      };

      const setupControls = () => {
        document.querySelectorAll('.control-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.view = btn.id.split('-')[0]; // mom | wow | dod
            populatePeriodSelector();
            renderAllCharts(allOrders);
          });
        });

        document.getElementById('period-select').addEventListener('change', (e) => {
          state.selectedPeriod = e.target.value;
          renderAllCharts(allOrders);
        });

        document.getElementById('load-data-btn').addEventListener('click', handleDataUpload);

        // Robust tab switching using data-target
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const targetId = btn.getAttribute('data-target');
            document.getElementById(targetId).classList.add('active');
            renderAllCharts(allOrders);
          });
        });
      };

      const handleDataUpload = () => {
        const fileInput = document.getElementById('data-file-input');
        const statusEl = document.getElementById('upload-status');
        const file = fileInput.files[0];
        if (!file) { statusEl.textContent = 'Please select a CSV file to upload.'; return; }
        statusEl.textContent = 'Loading...';

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const csvText = e.target.result;
            const newData = parseCSV(csvText);
            if (newData.length > 0) {
              allOrders = newData;
              renderAllCharts(allOrders);
              statusEl.textContent = 'Data loaded successfully!';
              statusEl.classList.remove('text-red-400'); statusEl.classList.add('text-green-400');
            } else {
              statusEl.textContent = 'CSV file is empty or formatted incorrectly.';
              statusEl.classList.remove('text-green-400'); statusEl.classList.add('text-red-400');
            }
          } catch (err) {
            console.error('Error parsing CSV:', err);
            statusEl.textContent = 'Error parsing file. Please ensure it is a valid CSV.';
            statusEl.classList.remove('text-green-400'); statusEl.classList.add('text-red-400');
          }
        };
        reader.onerror = () => {
          statusEl.textContent = 'Failed to read file.';
          statusEl.classList.remove('text-green-400'); statusEl.classList.add('text-red-400');
        };
        reader.readAsText(file);
      };

      // -------------------- Render all visuals --------------------
      const renderAllCharts = (data) => {
        const { currentPeriodOrders, prevPeriodOrders, periodStart } = processDataForPeriod(data, state.selectedPeriod, state.view);

        calculateKPIs(currentPeriodOrders, prevPeriodOrders);

        const retentionData = calculateRetention(data, periodStart, state.view);
        updateChart(
          charts.retention,
          retentionData.labels,
          [{ label: `Retention for ${format(periodStart, state.view === 'mom' ? 'MMM yyyy' : 'wo, yyyy')} Cohort`, data: retentionData.data, borderColor: '#3B82F6', tension: 0.4, fill: false }],
          { tooltipCallbacks: { label: (c) => `${c.raw.toFixed(1)}%` } }
        );

        const arpuData = calculateArpu(data, periodStart, state.view);
        updateChart(
          charts.arpu,
          arpuData.labels,
          [
            { label: 'Current Period', data: arpuData.currentData, borderColor: '#3B82F6', tension: 0.4 },
            { label: 'Previous Period', data: arpuData.prevData, borderColor: '#EAB308', tension: 0.4, borderDash: [5, 5] }
          ],
          { tooltipCallbacks: { label: (c) => `₹${c.parsed.y.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` } }
        );

        const recencyAgingData = calculateRecencyAging(allOrders);
        const recencyLabels = Object.keys(recencyAgingData.recencyMetrics);
        updateChart(
          charts.recencyAging,
          recencyLabels,
          [
            { label: 'ARPU', data: recencyLabels.map(l => recencyAgingData.recencyMetrics[l].arpu), backgroundColor: '#3B82F6' },
            { label: 'AOV', data: recencyLabels.map(l => recencyAgingData.recencyMetrics[l].aov), backgroundColor: '#EAB308' },
          ],
          { tooltipCallbacks: { label: (c) => `₹${c.parsed.y.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` } }
        );

        const orderRankData = calculateOrderRankFunnel(currentPeriodOrders);
        updateChart(
          charts.orderRankFunnel,
          orderRankData.labels,
          [
            { label: 'Total Revenue', data: orderRankData.totalRevenues, backgroundColor: 'rgba(59, 130, 246, 0.7)' },
            { label: 'AOV', data: orderRankData.aovs, backgroundColor: 'rgba(234, 179, 8, 0.7)' }
          ],
          { tooltipCallbacks: { label: (c) => `₹${c.parsed.y.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` } }
        );

        const conversionData = calculateConversion(currentPeriodOrders);
        updateChart(
          charts.conversion,
          conversionData.labels,
          [{ label: 'Conversion Rate', data: conversionData.data, backgroundColor: '#3B82F6' }],
          { horizontal: true, tooltipCallbacks: { label: (c) => `${c.raw.toFixed(1)}%` } }
        );

        const aovData = calculateAov(currentPeriodOrders, prevPeriodOrders);
        updateChart(
          charts.aov,
          ['Previous Period', 'Current Period'],
          [{ label: 'AOV', data: aovData.data, backgroundColor: ['#EAB308', '#3B82F6'] }],
          { tooltipCallbacks: { label: (c) => `₹${c.parsed.y.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` } }
        );

        const insights = generateInsights(currentPeriodOrders, prevPeriodOrders);
        document.getElementById('insights-content').innerHTML = insights.join('');

        const predictions = predictMonthEndValues(allOrders);
        document.getElementById('pred-revenue').textContent = formatINR(predictions.revenue);
        document.getElementById('pred-orders').textContent = predictions.orders.toLocaleString('en-IN', { maximumFractionDigits: 0 });
        document.getElementById('pred-users').textContent = predictions.users.toLocaleString('en-IN', { maximumFractionDigits: 0 });
        document.getElementById('pred-wc').textContent = formatINRDec(predictions.wc);
        document.getElementById('pred-funnel').innerHTML = `1st to 2nd: ${predictions.funnel['1st to 2nd'].toFixed(1)}%<br>WC per user: ${formatINRDec(predictions.wc)}`;
      };

      // -------------------- Boot --------------------
      const main = () => {
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9MKHElNPvzavMfIjy5Bu9qxq2rjGL7ynP1W_7xVmK5S6Of-Ye9h34ZtqDipVP46bsI4TtMHMPwM7F/pub?output=csv";

  fetch(csvUrl)
    .then(response => response.text())
    .then(csvText => {
      const parsed = parseCSV(csvText);
      allOrders = parsed;
      initCharts();
      setupControls();
      populatePeriodSelector();
      renderAllCharts(allOrders);
    })
    .catch(err => {
      console.error("Error fetching Google Sheet CSV:", err);
      // Fallback: still allow mock data if Google Sheets is unavailable
      allOrders = generateMockData().map(o => ({
        ...o,
        orderDate: new Date(o.orderDate),
        acquisitionDate: new Date(o.acquisitionDate)
      }));
      initCharts();
      setupControls();
      populatePeriodSelector();
      renderAllCharts(allOrders);
    });
};

main();
    });
  </script>
</body>
</html>
